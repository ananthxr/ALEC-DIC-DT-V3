========================================
ENERGY CHART - WEBSOCKET MESSAGE COMPARISON
========================================

ðŸ”µ WORKING MESSAGE FROM HELPER FILE (cmdId: 24):
========================================
{
  "cmds": [
    {
      "type": "ENTITY_DATA",
      "cmdId": 24,
      "historyCmd": {
        "keys": [
          "_ECD_BuildingWiseHourlyEnergyConsumption"
        ],
        "startTs": 1761595200000,
        "endTs": 1761681600000,
        "interval": 3600000,
        "intervalType": "MILLISECONDS",
        "limit": 24,
        "timeZoneId": "Asia/Dubai",
        "agg": "SUM"
      }
    }
  ]
}

ðŸŸ¢ WORKING RESPONSE (cmdId: 24):
========================================
{
  "cmdId": 24,
  "data": null,
  "update": [
    {
      "entityId": {
        "entityType": "ASSET",
        "id": "b6499190-6798-11f0-a54f-c718692b063f"
      },
      "readAttrs": true,
      "readTs": true,
      "latest": {
        "ENTITY_FIELD": {
          "name": {
            "ts": 1761655673533,
            "value": "DIC/Main"
          },
          "additionalInfo": {
            "ts": 1761655673533,
            "value": "{\"description\":\"\"}"
          },
          "label": {
            "ts": 1761655673533,
            "value": ""
          }
        }
      },
      "timeseries": {
        "_ECD_BuildingWiseHourlyEnergyConsumption": [
          {"ts": 1761597000000, "value": "13.199999999997999"},
          {"ts": 1761600600000, "value": "10.799999999799272"},
          {"ts": 1761604200000, "value": "12.800000000005639"},
          {"ts": 1761607800000, "value": "11.599999999996726"},
          {"ts": 1761611400000, "value": "11.200000000004366"},
          {"ts": 1761615000000, "value": "13.199999999994361"},
          {"ts": 1761618600000, "value": "23.200000000006185"},
          {"ts": 1761622200000, "value": "28.799999999994725"},
          {"ts": 1761625800000, "value": "33.19999999999982"},
          {"ts": 1761629400000, "value": "33.60000000000218"},
          {"ts": 1761633000000, "value": "33.99999999999545"},
          {"ts": 1761636600000, "value": "33.60000000000491"},
          {"ts": 1761640200000, "value": "31.99999999999909"},
          {"ts": 1761643800000, "value": "29.200000000003456"}
        ]
      },
      "aggLatest": {}
    }
  ],
  "errorCode": 0,
  "errorMsg": null,
  "allowedEntities": 10000,
  "cmdUpdateType": "ENTITY_DATA"
}

========================================
ðŸŸ¡ GENERATED BY ENERGYCHARTMANAGER:
========================================
Check Unity Console for output that says:
"[EnergyChart] ðŸ“¤ EXACT WebSocket Message Being Sent:"

Compare the generated message with the working message above.

========================================
âœ… CHECKLIST FOR MANUAL COMPARISON:
========================================

1. JSON Structure:
   [ ] "cmds" array exists
   [ ] "type" is "ENTITY_DATA"
   [ ] "cmdId" is a number (50 in our case)
   [ ] "historyCmd" object exists

2. historyCmd Fields:
   [ ] "keys" is an array with "_ECD_BuildingWiseHourlyEnergyConsumption"
   [ ] "startTs" is a valid Unix timestamp (milliseconds)
   [ ] "endTs" is a valid Unix timestamp (milliseconds)
   [ ] "interval" is 3600000 (for hourly) or 86400000 (for daily)
   [ ] "intervalType" is "MILLISECONDS"
   [ ] "limit" is 24 (for hourly) or 28 (for daily)
   [ ] "timeZoneId" is "Asia/Dubai"
   [ ] "agg" is "SUM"

3. JSON Formatting:
   [ ] No extra whitespace or newlines in unexpected places
   [ ] All strings are properly quoted
   [ ] No trailing commas
   [ ] Proper bracket/brace closure

4. Timestamp Validation:
   [ ] startTs < endTs
   [ ] Difference between startTs and endTs makes sense for the interval
   [ ] Example: For 24 hours, difference should be ~86400000ms

========================================
ðŸ”´ COMMON ISSUES THAT CAUSE ABNORMAL CLOSE:
========================================

1. WRONG TYPE:
   âŒ "type": "TIMESERIES_DATA"  (doesn't exist)
   âœ… "type": "ENTITY_DATA"

2. MISSING ENTITY SUBSCRIPTION:
   - Some servers require you to subscribe to entity first
   - Try using the same WebSocket connection as MasterAlarm

3. AUTHENTICATION EXPIRED:
   - Token might have expired
   - Check if MasterAlarm is still connected

4. MALFORMED JSON:
   - Extra quotes, missing commas, etc.
   - Use online JSON validator

5. INVALID TIMESTAMPS:
   - Timestamps in the future
   - Timestamps too far in the past
   - Wrong timezone

========================================
ðŸ› ï¸ DEBUGGING STEPS:
========================================

1. Copy the message from Unity Console (after ðŸ“¤ emoji)
2. Paste it into JSON validator: https://jsonlint.com/
3. Compare field-by-field with working message above
4. Check if timestamps are reasonable:
   - Convert timestamps: https://www.epochconverter.com/
   - Should be recent dates in Asia/Dubai timezone

5. Test with EXACT working message:
   - Change cmdId from 24 to 50 in working message
   - Use same timestamps from helper file
   - Send manually to see if it works

========================================
ðŸ’¡ ALTERNATIVE: USE MASTERALARM'S WEBSOCKET
========================================

Instead of creating a separate WebSocket connection,
you might want to use MasterAlarm's existing connection
and just send the energy data command through it.

This ensures:
- Same authentication
- Same connection state
- No conflicts

Would you like me to modify the script to use
MasterAlarm's WebSocket connection instead?

========================================
